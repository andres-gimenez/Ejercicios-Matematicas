name: Build Typst document (CI)
on: 
  push:
    paths: 
    - '.github/workflows/build.yaml'
    - 'Material/**/*.typ'
    - 'Material/**/*.yaml'
    - 'Material/**/*.toml'

  workflow_dispatch:

permissions:
  pages: write
  id-token: write
  contents: read

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
     
      - name: Delete samples and test
        run: |
          rm -rf ./Material/*.pdf
      
      - uses: typst-community/setup-typst@v4

      - name: Compile Typst examples with solution to PDF
        shell: bash
        run: |
          find ./Material -type f -name "*.typ" | while read -r archivo; do
              echo "Compilando: $archivo"
              typst compile "$archivo" --root . --input show-solutions=true || echo "Error en $archivo, continuando..."
          done

      - name: Rename files to (solution)
        shell: bash
        run: |
          find . -type f -iname '*.pdf' -print0 | while IFS= read -r -d '' f; do
            dir=$(dirname "$f")
            base=$(basename "$f" .pdf)

            # Evitar renombrar si ya termina en (soluciones)
            if [[ "$base" == *"(soluciones)" ]]; then
                continue
            fi

            mv "$f" "$dir/$base (soluciones).pdf"
          done

      - name: Compile Typst examples without solution to PDF
        shell: bash
        run: |
          find ./Material -type f -name "*.typ" | while read -r archivo; do
              echo "Compilando: $archivo"
              typst compile "$archivo" --root . --input show-solutions=false || echo "Error en $archivo, continuando..."
          done

      - name: Upload PDF file
        uses: actions/upload-artifact@v4
        with:
          name: material
          path: ./Material/**/*.pdf

      - name: Copy files
        run: |
          rm -rf ./public
          mkdir --parents ./public
          rsync -avL --include='*/' --include='*.pdf' --exclude='*' Material/ public/

      - name: Generate index.html
        run: |
          INDEX=public/index.html

          echo '<!doctype html>' > "$INDEX"
          echo '<html>' >> "$INDEX"
          echo '<head>' >> "$INDEX"
          echo '  <meta charset="utf-8">' >> "$INDEX"
          echo '  <title>Ejercicios de Matem√°ticas</title>' >> "$INDEX"
          echo '</head>' >> "$INDEX"
          echo '<body>' >> "$INDEX"
          echo '  <h1>Material</h1>' >> "$INDEX"
          echo '  <ul>' >> "$INDEX"

          find public -name "*.pdf" | sort | while read -r f; do
            rel="${f#public/}"
            name="$(basename "$f")"
            echo "    <li><a href=\"$rel\">$name</a></li>" >> "$INDEX"
          done

          echo '  </ul>' >> "$INDEX"
          echo '</body>' >> "$INDEX"
          echo '</html>' >> "$INDEX"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

