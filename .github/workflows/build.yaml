name: Build Typst document (CI)
on: 
  push:
    paths: 
    - '.github/workflows/build.yaml'
    - 'Material/**/*.typ'
    - 'Material/**/*.yaml'
    - 'Material/**/*.toml'

  workflow_dispatch:

permissions:
  pages: write
  id-token: write
  contents: read

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
     
      - name: Delete samples and test
        run: |
          rm -rf ./Material/*.pdf
      
      - uses: typst-community/setup-typst@v4

      - name: Compile Typst examples with solution to PDF
        shell: bash
        run: |
          find ./Material -type f -name "*.typ" | while read -r archivo; do
              echo "Compilando: $archivo"
              typst compile "$archivo" --root . --input show-solutions=true || echo "Error en $archivo, continuando..."
          done

      - name: Rename files to (solution)
        shell: bash
        run: |
          find . -type f -iname '*.pdf' -print0 | while IFS= read -r -d '' f; do
            dir=$(dirname "$f")
            base=$(basename "$f" .pdf)

            # Evitar renombrar si ya termina en (soluciones)
            if [[ "$base" == *"(soluciones)" ]]; then
                continue
            fi

            mv "$f" "$dir/$base (soluciones).pdf"
          done

      - name: Compile Typst examples without solution to PDF
        shell: bash
        run: |
          find ./Material -type f -name "*.typ" | while read -r archivo; do
              echo "Compilando: $archivo"
              typst compile "$archivo" --root . --input show-solutions=false || echo "Error en $archivo, continuando..."
          done

      - name: Upload PDF file
        uses: actions/upload-artifact@v4
        with:
          name: material
          path: ./Material/**/*.pdf

      - name: Copy files
        run: |
          rm -rf ./public
          mkdir -p ./public
          cp _L --parents ./Material/**/*.pdf ./public

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          name: MaterialPublish
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

