name: Build Typst document (CI)
on: 
  push:
    paths: 
    - '.github/workflows/build.yaml'
    - 'Material/**/*.typ'
    - 'Material/**/*.yaml'
    - 'Material/**/*.toml'

permissions:
  pages: write
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
     
      - name: Delete samples and test
        run: |
          rm -rf ./Material/*.pdf
      
      - uses: typst-community/setup-typst@v4

      - name: Compile Typst examples with solution to PDF
        shell: bash
        run: |
          find ./Material -type f -name "*.typ" | while read -r archivo; do
              echo "Compilando: $archivo"
              typst compile "$archivo" --root . --input show-solutions=true || echo "Error en $archivo, continuando..."
          done

      - name: Rename files to (solution)
        shell: bash
        run: |
          find . -type f -iname '*.pdf' -print0 | while IFS= read -r -d '' f; do
            dir=$(dirname "$f")
            base=$(basename "$f" .pdf)

            # Evitar renombrar si ya termina en (soluciones)
            if [[ "$base" == *"(soluciones)" ]]; then
                continue
            fi

            mv "$f" "$dir/$base (soluciones).pdf"
          done

      - name: Compile Typst examples without solution to PDF
        shell: bash
        run: |
          find ./Material -type f -name "*.typ" | while read -r archivo; do
              echo "Compilando: $archivo"
              typst compile "$archivo" --root . --input show-solutions=false || echo "Error en $archivo, continuando..."
          done

      - name: Upload PDF file
        uses: actions/upload-artifact@v4
        with:
          name: Material
          path: ./Material/**/*.pdf

      # - name: Copy files
      #   run: |
      #     mkdir -p ./public/Material
      #     cp ./Material/**/*.pdf ./public/Material/

      # - name: Upload artifact
      #   uses: actions/upload-pages-artifact@v4
      #   with:
      #     name: MaterialPublish
      #     path: ./public/Material/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        artifact_name: Material

